name: React CI/CD


on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest

        steps:
        - name: Checkout code
          uses: actions/checkout@v3

        - name: Install dependencies
          run: npm install
          working-directory: ./frontend

        - name: Build React App
          run: npm run build
          working-directory: ./frontend

        - name: Verify dist/ exists
          run: |
            cd frontend
            ls -la
            echo "Contents of dist folder"
            ls -la dist/
            echo "contents of dist/assets:"
            ls -la dist/assets/
 
        - name: Add SSH Private Key
          uses: webfactory/ssh-agent@v0.7.0
          with:
            ssh-private-key: ${{secrets.SSH_PRIVATE_KEY}}
        
        - name: Test SSH Connection
          run: ssh -p ${{ secrets.SSH_PORT}} -o StrictHostKeyChecking=no ${{secrets.SERVER_USER}}@${{secrets.SERVER_IP}} "echo 'Connected Successfully'"

        - name: Create remote directory
          run: |
            ssh -p ${{ secrets.SSH_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} \
              "mkdir -p ${{ secrets.DEPLOY_PATH }}"

        - name: Verify remote directory
          run: |
              ssh -p ${{ secrets.SSH_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} \
                "ls -la $(dirname ${{ secrets.DEPLOY_PATH }})"
    
        - name: Fix permissions if needed
          run: |
              ssh -p ${{ secrets.SSH_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} \
              "sudo mkdir -p ${{ secrets.DEPLOY_PATH }} && \
              sudo chown -R ${{ secrets.SERVER_USER }}:${{ secrets.SERVER_USER }} ${{ secrets.DEPLOY_PATH }}"
                
        - name: Deploy to VPS
          env:
            SERVER_IP: ${{ secrets.SERVER_IP}}
            SERVER_USER: ${{ secrets.SERVER_USER}}
            DEPLOY_PATH: ${{ secrets.DEPLOY_PATH}}
            SSH_PORT: ${{ secrets.SSH_PORT}}
          run: |
           scp -P ${{ secrets.SSH_PORT }} \
              -o StrictHostKeyChecking=no \
              -r dist/* \
              ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:${{ secrets.DEPLOY_PATH}}/
          working-directory: ./frontend

        - name: Verify remote directory
          run: |
            ssh -p ${{ secrets.SSH_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} \
              "ls -la $(dirname ${{ secrets.DEPLOY_PATH }})"

        - name: Fix permissions if needed
          run: |
            ssh -p ${{ secrets.SSH_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} \
            "sudo mkdir -p ${{ secrets.DEPLOY_PATH }} && \
            sudo chown -R ${{ secrets.SERVER_USER }}:${{ secrets.SERVER_USER }} ${{ secrets.DEPLOY_PATH }}"
